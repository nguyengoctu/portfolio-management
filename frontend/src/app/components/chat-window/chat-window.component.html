<div 
  class="chat-window fixed bottom-0 right-4 bg-white shadow-2xl rounded-t-lg border border-gray-200 z-40"
  [class.minimized]="isMinimized"
  *ngIf="chatUser"
>
  <!-- Chat Header -->
  <div class="chat-header flex items-center justify-between px-4 py-3 bg-indigo-600 text-white rounded-t-lg cursor-pointer" 
       (click)="minimizeChat()">
    <div class="flex items-center space-x-3">
      <div class="relative">
        <img 
          [src]="chatUser.profileImageUrl || getDefaultAvatar()" 
          [alt]="chatUser.name"
          class="w-8 h-8 rounded-full object-cover border-2 border-white"
        />
        <div class="absolute -bottom-0 -right-0 w-3 h-3 bg-green-400 border-2 border-white rounded-full"></div>
      </div>
      <div>
        <h3 class="text-sm font-semibold">{{ chatUser.name }}</h3>
        <p class="text-xs text-indigo-200">Online</p>
      </div>
    </div>
    
    <div class="flex items-center space-x-2">
      <!-- Minimize Button -->
      <button 
        (click)="minimizeChat(); $event.stopPropagation()"
        class="hover:bg-indigo-500 p-1 rounded transition-colors duration-200"
      >
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd"/>
        </svg>
      </button>
      
      <!-- Close Button -->
      <button 
        (click)="closeChat(); $event.stopPropagation()"
        class="hover:bg-indigo-500 p-1 rounded transition-colors duration-200"
      >
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Chat Body (hidden when minimized) -->
  <div class="chat-body" *ngIf="!isMinimized">
    <!-- Messages Container -->
    <div 
      #messagesContainer
      class="messages-container h-80 overflow-y-auto p-4 space-y-3 bg-gray-50"
    >
      <!-- No messages placeholder -->
      <div *ngIf="messages.length === 0" class="flex flex-col items-center justify-center h-full text-gray-500">
        <svg class="w-12 h-12 mb-3 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm2 0h2v2H9V8zm6 0h-2v2h2V8z" clip-rule="evenodd"/>
        </svg>
        <p class="text-sm">Start a conversation with {{ chatUser.name }}!</p>
      </div>

      <!-- Messages -->
      <div 
        *ngFor="let message of messages" 
        class="message"
        [class.sent]="isMessageFromCurrentUser(message)"
        [class.received]="!isMessageFromCurrentUser(message)"
      >
        <div class="message-bubble">
          <p class="message-text">{{ message.message }}</p>
          <div class="message-meta">
            <span class="message-time">{{ formatMessageTime(message.timestamp) }}</span>
            <span 
              *ngIf="isMessageFromCurrentUser(message)" 
              class="message-status ml-1"
              [class.read]="message.read"
            >
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Message Input -->
    <div class="chat-input px-4 py-3 bg-white border-t border-gray-200">
      <div class="flex items-center space-x-2">
        <div class="flex-1">
          <input
            type="text"
            [(ngModel)]="newMessage"
            (keypress)="onKeyPress($event)"
            placeholder="Type a message..."
            class="w-full px-3 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
            maxlength="500"
          />
        </div>
        <button
          (click)="sendMessage()"
          [disabled]="!newMessage.trim()"
          class="bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white p-2 rounded-full transition-colors duration-200"
        >
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
          </svg>
        </button>
      </div>
      
      <!-- Character counter -->
      <div class="text-xs text-gray-500 text-right mt-1" *ngIf="newMessage.length > 400">
        {{ newMessage.length }}/500
      </div>
    </div>
  </div>
</div>